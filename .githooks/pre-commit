#!/usr/bin/env bash
#
# pre-commit hook (repo-managed)
#
# Purpose:
# - If "code paths" are modified but VERSION isn't bumped, auto-bump patch version and stage it.
# - Keep VERSION and .claude-plugin/plugin.json in sync.
# - Warn if CHANGELOG.md is not updated when version is bumped.
#
# Install:
#   ./scripts/install-git-hooks.sh
#

set -euo pipefail

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$ROOT" ]; then
  exit 0
fi

cd "$ROOT"

CODE_PATHS=(commands/ skills/ templates/ scripts/ hooks/ agents/ workflows/)

# Staged code changes?
CHANGED_CODE="$(git diff --cached --name-only -- "${CODE_PATHS[@]}" 2>/dev/null | grep -v '^$' || true)"
if [ -z "$CHANGED_CODE" ]; then
  # Even if no code changes, keep VERSION/plugin.json consistent when those files are staged.
  if [ -f "./scripts/sync-version.sh" ]; then
    if ! bash ./scripts/sync-version.sh check >/dev/null 2>&1; then
      echo "[pre-commit] VERSION and plugin.json mismatch. Syncing..."
      bash ./scripts/sync-version.sh sync
      git add VERSION .claude-plugin/plugin.json 2>/dev/null || true
    fi
  fi
  exit 0
fi

# If we have code changes staged, require version bump (auto-fix by bumping patch).
BASE_VERSION="$(git show HEAD:VERSION 2>/dev/null | tr -d '[:space:]' || echo "")"
INDEX_VERSION="$(git show :VERSION 2>/dev/null | tr -d '[:space:]' || echo "")"

if [ -z "$INDEX_VERSION" ] && [ -f VERSION ]; then
  INDEX_VERSION="$(cat VERSION | tr -d '[:space:]')"
fi

if [ -z "$BASE_VERSION" ] || [ -z "$INDEX_VERSION" ]; then
  # Initial commit or missing VERSION; don't block.
  exit 0
fi

VERSION_BUMPED=false

if [ "$BASE_VERSION" = "$INDEX_VERSION" ]; then
  echo "[pre-commit] Code changes staged but VERSION not bumped ($INDEX_VERSION)."
  echo "             -> Auto-bumping patch version..."

  bash ./scripts/sync-version.sh bump

  # Stage version files (and optional synced files if updated by scripts)
  git add VERSION .claude-plugin/plugin.json 2>/dev/null || true
  git add .claude-plugin/marketplace.json README.md 2>/dev/null || true

  NEW_VERSION="$(cat VERSION | tr -d '[:space:]')"
  echo "[pre-commit] VERSION updated: $BASE_VERSION -> $NEW_VERSION"
  VERSION_BUMPED=true
else
  # Version was already bumped manually
  VERSION_BUMPED=true
fi

# Check if CHANGELOG.md is updated when version is bumped
if [ "$VERSION_BUMPED" = true ]; then
  CHANGELOG_STAGED="$(git diff --cached --name-only -- CHANGELOG.md 2>/dev/null || true)"
  if [ -z "$CHANGELOG_STAGED" ]; then
    echo ""
    echo "================================================================"
    echo "[pre-commit] WARNING: CHANGELOG.md not updated!"
    echo "================================================================"
    echo ""
    echo "  Code changes detected but CHANGELOG.md was not modified."
    echo "  Please update CHANGELOG.md with:"
    echo ""
    echo "    ## [$(cat VERSION)] - $(date +%Y-%m-%d)"
    echo ""
    echo "    ### What changed"
    echo "    - Your changes here..."
    echo ""
    echo "  Run: git add CHANGELOG.md && git commit --amend"
    echo ""
    echo "================================================================"
    echo ""
    # Warning only, don't block the commit
  fi
fi

exit 0
