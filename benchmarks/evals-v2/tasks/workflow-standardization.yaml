# 評価次元1: ワークフロー標準化価値
#
# 仮説: ハーネスのワークフロー（Plan→Work→Review）は、
#       ユーザーが自然に犯すミスを防ぐ
#
# 測定対象: 失敗パターンからの回避率

dimension: workflow-standardization
version: "1.0"
description: |
  ハーネスのワークフロー（Plan→Work→Review）がミスを防ぐ効果を測定する。
  実際の失敗パターンから抽出したタスクを使用し、ハーネスがこれらの
  トラップを回避できるかを評価する。

# 各タスクは「実際の失敗パターン」から抽出
tasks:
  # WF-01: 計画なしで実装を始めて手戻りが発生
  - id: WF-01
    name: immediate-implementation
    description: 「すぐこの機能追加して」という依頼
    trap:
      type: no_planning
      description: 計画なしで実装→手戻りが発生
    expected_prevention: /plan-with-agent が計画を強制
    prompt: |
      ユーザーリスト画面にフィルター機能を追加してください。
      すぐに実装してほしいです。
    success_criteria:
      - Plans.md が作成される
      - 計画が承認されてから実装が始まる
      - 要件が明確化される
    failure_indicators:
      - 計画なしで直接コード編集を開始
      - 要件確認なしで実装
      - 手戻りが発生

  # WF-02: バグ修正時に回帰テストを作らない
  - id: WF-02
    name: bugfix-without-test
    description: 「このバグ直して」という依頼
    trap:
      type: no_regression_test
      description: 回帰テストなし→再発
    expected_prevention: /work がテスト作成を推奨
    prompt: |
      ログイン画面でパスワードが空のときにエラーが出ません。
      修正してください。
    success_criteria:
      - 再現テストが作成される
      - バグ修正後にテストがパスする
      - 回帰を防ぐテストが残る
    failure_indicators:
      - テストなしでコード修正のみ
      - 既存テストを変更して通す

  # WF-03: レビューなしでデプロイして問題発覚
  - id: WF-03
    name: deploy-without-review
    description: 「リファクタして」という依頼
    trap:
      type: no_review
      description: レビューなし→破壊的変更
    expected_prevention: /harness-review が検出
    prompt: |
      認証モジュールをリファクタリングしてください。
      コードが複雑になってきたので整理したいです。
    success_criteria:
      - リファクタ後にレビューが実行される
      - 破壊的変更がないことを確認
      - テストがパスする
    failure_indicators:
      - レビューなしで変更をコミット
      - 既存テストが失敗

  # WF-04: セキュリティ考慮なしで認証機能を実装
  - id: WF-04
    name: auth-without-security
    description: 「認証追加して」という依頼
    trap:
      type: security_oversight
      description: セキュリティ考慮なし
    expected_prevention: "[feature:security] マーカー"
    prompt: |
      管理者向けのAPIエンドポイントを追加してください。
      管理者だけがアクセスできるようにしたいです。
    success_criteria:
      - 認証チェックが実装される
      - 認可（権限）チェックが実装される
      - セキュリティレビューが実行される
    failure_indicators:
      - 認証なしでエンドポイント公開
      - ハードコードされた認証情報
      - OWASP Top 10 違反

  # WF-05: アクセシビリティ考慮なしでUI実装
  - id: WF-05
    name: ui-without-a11y
    description: 「UI作って」という依頼
    trap:
      type: a11y_oversight
      description: アクセシビリティ考慮なし
    expected_prevention: "[feature:a11y] マーカー"
    prompt: |
      ダッシュボード画面のヘッダーコンポーネントを作成してください。
      ナビゲーションメニューとユーザー情報を表示します。
    success_criteria:
      - セマンティックHTML使用
      - ARIA属性が適切
      - キーボード操作対応
    failure_indicators:
      - div/spanのみでマークアップ
      - alt属性なし
      - フォーカス管理なし

# グレーダー設定
graders:
  code_based:
    - name: plans_md_created
      type: boolean
      check: "test -f Plans.md"
      weight: 1.0
      required: true

    - name: test_files_created
      type: boolean
      check: "find . -name '*.test.ts' -o -name '*.spec.ts' | wc -l"
      threshold: "> 0"
      weight: 1.0
      required: true

    - name: review_executed
      type: boolean
      check: "grep -l 'harness-review' .claude/state/*.json 2>/dev/null | wc -l"
      threshold: "> 0"
      weight: 1.0
      required: false

    - name: markers_applied
      type: list
      check: "grep -E '\\[feature:(security|a11y|performance)\\]' Plans.md"
      weight: 0.5
      required: false

  model_based:
    - name: plan_quality
      prompt: |
        この計画は実装可能で網羅的か？1-5で評価してください。

        計画内容:
        {plans_md_content}

        評価基準:
        5: 完璧な計画、すべての要件を網羅
        4: 良い計画、軽微な漏れ
        3: 普通、主要な要件は網羅
        2: 不十分、重要な漏れ
        1: 計画として機能しない
      weight: 1.0

    - name: test_coverage
      prompt: |
        テストは重要なケースを網羅しているか？1-5で評価してください。

        テストファイル:
        {test_files_content}

        評価基準:
        5: すべての重要なケースを網羅
        4: ほとんどのケースを網羅
        3: 主要なケースのみ
        2: 不十分なカバレッジ
        1: テストがない/意味がない
      weight: 1.0

    - name: review_thoroughness
      prompt: |
        レビューは問題を適切に指摘しているか？1-5で評価してください。

        レビュー結果:
        {review_output}

        評価基準:
        5: すべての問題を正確に指摘
        4: 重要な問題を指摘
        3: 一部の問題を指摘
        2: 表面的なレビュー
        1: レビューがない/意味がない
      weight: 1.0

# メトリクス定義
metrics:
  mistake_prevention_rate:
    formula: "(traps_avoided / total_traps)"
    description: "トラップを回避した割合"
    target: ">= 0.8"

  process_compliance_score:
    formula: "(executed_steps / recommended_steps)"
    description: "推奨ステップの遵守率"
    target: ">= 0.9"

# 試行設定
trials:
  minimum: 10
  recommended: 30
  per_task: 3
