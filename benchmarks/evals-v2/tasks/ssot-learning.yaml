# 評価次元2: 知識蓄積効果（SSOT）
#
# 仮説: decisions.md と patterns.md に蓄積された知識は、
#       複数セッションにわたって性能を向上させる
#
# 測定対象: セッション間の学習効果

dimension: ssot-learning
version: "1.0"
description: |
  SSOT（Single Source of Truth）ファイルに蓄積された知識が、
  複数セッションにわたって性能を向上させる効果を測定する。
  縦断評価設計により、学習曲線と一貫性を評価する。

# 縦断評価: 4つのセッションで構成
sessions:
  # Session 1: 冷間起動、SSOTなし
  - id: S1
    name: cold-start
    description: 新規プロジェクトで認証機能を実装（SSOT蓄積の起点）
    ssot_state: empty
    task:
      id: SSOT-01
      name: implement-auth
      prompt: |
        このプロジェクトに認証機能を実装してください。
        JWT認証を使用し、ログイン/ログアウト/セッション管理を実装します。
      expected_ssot_additions:
        decisions:
          - "JWT vs Session: JWTを選択した理由"
          - "トークン有効期限: 選択した値と理由"
          - "リフレッシュトークン: 使用するかどうかの決定"
        patterns:
          - "認証ミドルウェアの実装パターン"
          - "トークン検証の実装パターン"
    success_criteria:
      - 認証機能が動作する
      - decisions.md に決定事項が記録される
      - patterns.md にパターンが記録される

  # Session 2: Session 1 の SSOT を参照
  - id: S2
    name: incremental-auth
    description: 権限管理を追加（Session 1 の SSOT を参照）
    ssot_state: from_session_1
    task:
      id: SSOT-02
      name: add-authorization
      prompt: |
        認証機能に権限管理を追加してください。
        ロールベースのアクセス制御（RBAC）を実装します。
      expected_consistency:
        - "Session 1 のJWT決定と整合する実装"
        - "既存の認証パターンを再利用"
    success_criteria:
      - 権限管理が動作する
      - Session 1 の決定と一貫している
      - 既存パターンを再利用している
      - 実装時間が Session 1 より短い

  # Session 3: 複合的な知識の活用
  - id: S3
    name: composite-knowledge
    description: 監査ログを追加（認証+権限の知識を活用）
    ssot_state: from_session_1_and_2
    task:
      id: SSOT-03
      name: add-audit-log
      prompt: |
        認証・権限管理に監査ログ機能を追加してください。
        誰が、いつ、何をしたかを記録します。
      expected_knowledge_usage:
        - "認証トークンからユーザー情報を取得"
        - "権限チェック結果をログに含める"
        - "既存パターンとの一貫性"
    success_criteria:
      - 監査ログが動作する
      - 過去の決定と一貫している
      - 複合的な知識を活用している
      - 実装時間が Session 1,2 より短い

  # Session 4: 意図的な質問でSSOT参照精度を測定
  - id: S4
    name: knowledge-retrieval
    description: 過去の決定について質問（SSOT参照精度の測定）
    ssot_state: from_session_1_2_3
    task:
      id: SSOT-04
      name: recall-decisions
      prompt: |
        以下の質問に答えてください:
        1. セッション管理はどのような方式を採用しましたか？その理由は？
        2. トークンの有効期限はどのくらいですか？なぜその値にしましたか？
        3. 権限管理のパターンはどのように実装されていますか？
      expected_accuracy:
        - "decisions.md から正確に回答"
        - "patterns.md から正確に回答"
        - "過去の決定理由を正しく説明"
    success_criteria:
      - SSOTから正確に情報を取得
      - 決定理由を正しく説明
      - パターンを正しく説明

# グレーダー設定
graders:
  code_based:
    - name: duration_trend
      type: list_float
      description: "各セッションの所要時間（秒）"
      check: "jq '.duration_seconds' results/*.json"
      expected_trend: decreasing
      weight: 1.0

    - name: error_rate_trend
      type: list_float
      description: "各セッションのエラー率"
      check: "jq '.error_count / .total_operations' results/*.json"
      expected_trend: decreasing
      weight: 1.0

    - name: ssot_file_changes
      type: dict
      description: "SSOTファイルの変更検出"
      check: "git diff --stat .claude/memory/"
      weight: 0.5

    - name: pattern_reuse_count
      type: int
      description: "パターン再利用回数"
      check: "grep -c 'patterns.md' .claude/state/*.json"
      weight: 0.5

  model_based:
    - name: consistency_with_past
      prompt: |
        この実装は過去の決定と一貫しているか？1-5で評価してください。

        過去の決定（decisions.md）:
        {decisions_md_content}

        今回の実装:
        {current_implementation}

        評価基準:
        5: 完全に一貫している
        4: ほぼ一貫している
        3: 部分的に一貫
        2: 矛盾がある
        1: 過去の決定を無視
      weight: 1.0

    - name: knowledge_application
      prompt: |
        過去のパターンを適切に活用しているか？1-5で評価してください。

        利用可能なパターン（patterns.md）:
        {patterns_md_content}

        今回の実装:
        {current_implementation}

        評価基準:
        5: パターンを完璧に活用
        4: ほとんどのパターンを活用
        3: 一部のパターンを活用
        2: パターンをほぼ活用していない
        1: パターンを無視して再実装
      weight: 1.0

    - name: recall_accuracy
      prompt: |
        SSOTから情報を正確に取得しているか？1-5で評価してください。

        SSOT内容:
        decisions.md: {decisions_md_content}
        patterns.md: {patterns_md_content}

        エージェントの回答:
        {agent_response}

        評価基準:
        5: 完全に正確
        4: ほぼ正確
        3: 部分的に正確
        2: 多くの誤り
        1: 完全に不正確
      weight: 1.0

# メトリクス定義
metrics:
  learning_curve:
    formula: "(session_n_duration / session_1_duration)"
    description: "学習曲線（1.0未満なら改善）"
    target: "< 0.7 for session 3"

  consistency_score:
    formula: "(decisions_followed / relevant_decision_points)"
    description: "過去決定への従順率"
    target: ">= 0.9"

  error_repetition_rate:
    formula: "(ssot_recorded_mistakes_repeated / total_relevant_situations)"
    description: "SSOT記録済みミスの再発率（0が理想）"
    target: "= 0"

# 試行設定
trials:
  minimum: 5
  recommended: 10
  note: "縦断評価のため、1試行 = 4セッション"

# 環境要件
environment:
  isolation: per_session
  ssot_persistence: across_sessions_within_trial
  state_reset: between_trials
