# 評価 v3: 曖昧プロンプト比較タスク（非エンジニア風）
#
# 仮説: ハーネスのルール・スキルは曖昧な指示を構造化されたワークフローに変換する
#
# 設計原則:
#   - 非エンジニア（VibeCoder）が実際に言いそうな表現
#   - 意図的な間違いワード（技術用語の誤用）
#   - 矛盾した要件
#   - 曖昧な範囲指定
#
# 比較方法:
#   with-plugin: claude -p --plugin-dir {プロンプト}（ルール・スキルが読み込まれる）
#   no-plugin:   claude -p {プロンプト}（素の Claude）
#
# Note: -p モードではスラッシュコマンドが使えないため、自然言語でプロンプトし、
#       プラグインのルール（.claude/rules/）とスキルがどの程度影響するかを測定

version: "3.1"
description: |
  非エンジニア（VibeCoder）が書くような曖昧なプロンプトを使用し、
  プラグインの有無で結果がどう変わるかを測定する。

  プロンプトには以下を含む:
  - 技術用語の誤用（「サーバー」→「サーバ」、「データベース」→「データ」）
  - 矛盾する要件（「シンプルだけど全部入り」）
  - 曖昧な範囲（「いい感じに」「ちゃんと」）
  - 参照不足（「あの機能」「前のやつ」）

tasks:
  # VP-01: 機能追加の曖昧な依頼（間違いワード＋範囲不明確）
  - id: VP-01
    name: vague-user-management
    prompt: "ユーザーのログイン情報とか管理するやつ作って、データはサーバに保存してね。あとセキュリティはちゃんとしてほしい"
    issues:
      - 「サーバに保存」が DB なのかファイルなのか不明
      - 「ログイン情報」がユーザー管理なのか認証なのか不明
      - 「セキュリティはちゃんと」が具体的に何か不明
      - 「とか」で範囲が曖昧
    expected_clarifications:
      - ユーザー管理 vs 認証の確認
      - ストレージ方式の確認
      - セキュリティ要件の具体化
    success_criteria:
      plans_exists: true
      requirements_clarified: true
      security_markers: ">= 1"

  # VP-02: UI作成の曖昧な依頼（矛盾＋参照不足）
  - id: VP-02
    name: vague-login-ui
    prompt: "ログイン画面つくって！シンプルでいいけどTwitterとかGoogleでもログインできるようにして、あとメールでも入れるようにして。全部対応ね。デザインはいい感じにして"
    issues:
      - 「シンプル」と「全部対応」が矛盾
      - 「いい感じ」が主観的で不明確
      - 認証方式（OAuth等）を知らずに要求している
      - 技術的な難易度を理解していない
    expected_clarifications:
      - 認証方式の優先度確認
      - 「シンプル」の定義確認
      - デザイン要件の具体化
    success_criteria:
      plans_exists: true
      security_markers: ">= 1"
      contradiction_resolved: true

  # VP-03: バグ修正の曖昧な依頼（情報不足＋誤用）
  - id: VP-03
    name: vague-bugfix
    prompt: "なんかエラーが出るから直して。前は動いてたのに急に動かなくなった。多分データの変換のとこがおかしい"
    issues:
      - エラー内容が不明（「なんか」）
      - 再現条件が不明
      - 「多分」で原因推測が曖昧
      - どの「データの変換」か不明
    setup:
      bug_file: "src/utils.ts"
      bug_content: |
        export function calculate(a: number, b: number): number {
          return a / b;  // バグ: ゼロ除算チェックなし
        }

        export function formatDate(date: Date): string {
          return date.toISOString();
        }
    expected_clarifications:
      - エラーメッセージの確認
      - 再現手順の確認
      - 影響範囲の確認
    success_criteria:
      plans_exists: true
      test_mentioned: true
      root_cause_investigation: true

  # VP-04: リファクタの曖昧な依頼（目的不明＋範囲不明）
  - id: VP-04
    name: vague-refactor
    prompt: "コードがなんか汚いから綺麗にして。読みにくいし、あと動作は変えないでね"
    issues:
      - 「汚い」「綺麗」が主観的
      - どのファイル/範囲が対象か不明
      - 「読みにくい」の基準が不明
      - 「動作は変えない」の検証方法が不明
    expected_clarifications:
      - 対象範囲の確認
      - 「綺麗」の定義確認
      - 動作保証の方法確認
    success_criteria:
      plans_exists: true
      test_mentioned: true
      scope_clarified: true

  # VP-05: API作成の曖昧な依頼（技術誤用＋矛盾）
  - id: VP-05
    name: vague-api
    prompt: "なんかデータを画面に表示するやつ作って。サーバー側の処理？よくわからないけど。あとから機能追加しやすくて、でもシンプルなのがいい"
    issues:
      - 「サーバー側の処理」が何か理解していない
      - 「シンプル」と「機能追加しやすい」が時に矛盾
      - 「データ」が何か不明
      - 技術スタックの指定なし
    expected_clarifications:
      - API方式の決定
      - データモデルの確認
      - エンドポイント設計の確認
    success_criteria:
      plans_exists: true
      api_design: true
      security_markers: ">= 1"

# グレーダー設定
graders:
  code_based:
    - name: plans_exists
      check: "test -f Plans.md && echo 1 || echo 0"
      weight: 2.0
      description: "Plans.md が作成されたか"

    - name: plans_line_count
      check: "wc -l < Plans.md 2>/dev/null || echo 0"
      weight: 1.0
      description: "Plans.md の行数（計画の詳細度）"
      scoring:
        "0": 0
        "1-20": 1
        "21-50": 2
        "51-100": 3
        "101+": 4

    - name: phase_count
      check: "grep -c '^## .*フェーズ' Plans.md 2>/dev/null || echo 0"
      weight: 1.0
      description: "フェーズ数（計画の構造化度）"

    - name: tdd_markers
      check: "grep -c '\\[feature:tdd\\]' Plans.md 2>/dev/null || echo 0"
      weight: 1.5
      description: "TDD マーカーの数"

    - name: security_markers
      check: "grep -c '\\[feature:security\\]' Plans.md 2>/dev/null || echo 0"
      weight: 1.5
      description: "セキュリティマーカーの数"

    - name: test_table_exists
      check: "grep -c '| テストケース |' Plans.md 2>/dev/null || echo 0"
      weight: 1.5
      description: "テストケース表の存在"

    - name: test_files_created
      check: "find . -name '*.test.ts' -o -name '*.spec.ts' 2>/dev/null | wc -l"
      weight: 1.0
      description: "テストファイルの数"

    - name: clarification_questions
      check: "grep -cE '(確認|質問|どの|どれ|どう)' Plans.md 2>/dev/null || echo 0"
      weight: 1.0
      description: "明確化のための質問・確認の存在"

  model_based:
    - name: plan_quality
      prompt: |
        この出力から、曖昧な要求に対して適切な計画が立てられたかを評価してください。

        評価基準:
        5: 曖昧さを完全に解消し、詳細で実行可能な計画
        4: ほとんどの曖昧さを解消、軽微な不明点のみ
        3: 基本的な計画はあるが、いくつかの曖昧さが残る
        2: 計画が不十分、多くの曖昧さが未解消
        1: 計画なし、または曖昧なまま実装開始
      weight: 2.0

    - name: requirements_clarity
      prompt: |
        曖昧な依頼に対して、要件を明確化する質問や確認が行われたかを評価してください。

        元の依頼には以下の問題がありました:
        - 技術用語の誤用
        - 矛盾する要件
        - 曖昧な範囲指定

        評価基準:
        5: すべての曖昧さを特定し、適切に確認
        4: 主要な曖昧さを確認、軽微な漏れ
        3: 一部の曖昧さのみ確認
        2: ほとんど確認なし
        1: 確認なしで実装、曖昧さを無視
      weight: 1.5

    - name: contradiction_handling
      prompt: |
        矛盾する要件（例: 「シンプルだけど全部対応」）に対して、
        適切に対処できたかを評価してください。

        評価基準:
        5: 矛盾を明確に指摘し、優先度を確認して解決
        4: 矛盾を認識し、妥当な判断で解決
        3: 矛盾を部分的に認識
        2: 矛盾を無視して実装
        1: 矛盾に気づかず、両方を実装しようとして失敗
      weight: 1.5

# メトリクス
metrics:
  structuring_rate:
    formula: "(with_plugin_score - no_plugin_score) / max_score"
    description: "プラグインによる構造化の効果"
    target: "> 0.3"

  planning_rate:
    formula: "plans_created_with_plugin / total_trials"
    description: "プラグインあり時の計画作成率"
    target: "> 0.9"

  clarification_rate:
    formula: "clarifications_made_with_plugin / total_ambiguities"
    description: "曖昧さの解消率"
    target: "> 0.7"

# 試行設定
trials:
  minimum: 20
  recommended: 30
  per_task: 20
  timeout_seconds: 180
