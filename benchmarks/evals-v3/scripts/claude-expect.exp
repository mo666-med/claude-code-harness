#!/usr/bin/expect -f
# Claude Code 自動化スクリプト
# Usage: ./claude-expect.exp "プロンプト" [タイムアウト秒]

set timeout [lindex $argv 1]
if {$timeout == ""} {set timeout 120}

set prompt [lindex $argv 0]
if {$prompt == ""} {
    puts "Usage: ./claude-expect.exp \"prompt\" \[timeout\]"
    exit 1
}

# Claude を起動
spawn claude --dangerously-skip-permissions

# プロンプト入力待ち
expect {
    "❯" {
        send "$prompt\r"
    }
    timeout {
        puts "ERROR: Timeout waiting for Claude prompt"
        exit 1
    }
}

# 応答を待つ（質問が来たらEnterで進む）
set max_iterations 10
set iteration 0

while {$iteration < $max_iterations} {
    expect {
        # 質問への選択肢が表示されたらEnterで選択
        "Enter to select" {
            send "\r"
            incr iteration
        }
        # 完了したら終了
        "✅" {
            puts "\n=== COMPLETED ==="
            break
        }
        # 新しいプロンプト待ちになったら終了
        -re "❯\\s*$" {
            puts "\n=== READY FOR INPUT ==="
            break
        }
        timeout {
            puts "\n=== TIMEOUT ==="
            break
        }
    }
}

# Ctrl+C で終了
send "\x03"
expect eof
