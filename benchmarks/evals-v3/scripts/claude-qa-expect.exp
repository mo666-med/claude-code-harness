#!/usr/bin/expect -f
# claude-qa-expect.exp - 質問への自動回答付き Claude 自動化
#
# Usage: ./claude-qa-expect.exp "プロンプト" "回答1|回答2|回答3" [タイムアウト秒]
#
# 質問が来たら定義済み回答を順番に送信し、選択肢が来たらEnterで進む

set timeout [lindex $argv 2]
if {$timeout == ""} {set timeout 180}

set prompt [lindex $argv 0]
if {$prompt == ""} {
    puts "Usage: ./claude-qa-expect.exp \"prompt\" \"answer1|answer2|...\" \[timeout\]"
    exit 1
}

set answers_raw [lindex $argv 1]
set answers [split $answers_raw "|"]
set answer_index 0
set max_answers [llength $answers]

# Claude を起動
spawn claude --dangerously-skip-permissions

# プロンプト入力待ち
expect {
    "❯" {
        send "$prompt\r"
    }
    timeout {
        puts "ERROR: Timeout waiting for Claude prompt"
        exit 1
    }
}

# 応答を待つ（質問/選択肢を処理）
set max_iterations 20
set iteration 0

while {$iteration < $max_iterations} {
    expect {
        # 選択肢が表示されたらEnterで最初の選択肢を選ぶ
        "Enter to select" {
            send "\r"
            incr iteration
        }
        # 質問マーク検出（テキスト入力が必要な質問）
        -re {(\?|？)\s*$} {
            if {$answer_index < $max_answers} {
                set answer [lindex $answers $answer_index]
                puts "\n>>> AUTO-ANSWER: $answer"
                send "$answer\r"
                incr answer_index
            } else {
                # 回答がなくなったらEnterで進む
                send "\r"
            }
            incr iteration
        }
        # AskUserQuestion の選択肢（番号選択）
        -re {\[1\].*\[2\]} {
            # 最初の選択肢を選ぶ
            send "1\r"
            incr iteration
        }
        # 完了したら終了
        "✅" {
            puts "\n=== COMPLETED ==="
            break
        }
        # Plans.md 生成完了
        "Plans.md" {
            # もう少し待って安定させる
            sleep 2
        }
        # 新しいプロンプト待ちになったら終了
        -re {❯\s*$} {
            puts "\n=== READY FOR INPUT ==="
            break
        }
        timeout {
            puts "\n=== TIMEOUT ==="
            break
        }
    }
}

# 終了
send "/exit\r"
expect eof
