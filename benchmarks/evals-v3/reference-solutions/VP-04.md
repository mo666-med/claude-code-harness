# Reference Solution: VP-04 (リファクタの曖昧な依頼)

## 元のプロンプト

「コードがなんか汚いから綺麗にして。読みにくいし、あと動作は変えないでね」

## 曖昧さの問題点

1. **「汚い」「綺麗」が主観的**: 具体的な基準がない
2. **対象範囲が不明**: どのファイル/関数が対象か
3. **「読みにくい」の基準が不明**: 誰にとって読みにくいのか
4. **「動作は変えない」の検証方法が不明**: テストがあるのか

## 参照解（理想的な Plans.md）

```markdown
# Plans.md - リファクタリング計画

## 要件確認（ユーザーへのヒアリング結果）

### 範囲と基準の明確化

| 項目 | ユーザーへの質問 | 回答・決定 |
|------|-----------------|-----------|
| 対象範囲 | 「どのファイルが気になる？」 | src/utils.ts と src/components/ |
| 「汚い」の定義 | 「具体的にどこが気になる？」 | 関数が長い、変数名が分かりにくい |
| 「読みにくい」 | 「誰が読む想定？」 | 将来の自分やチームメンバー |
| テストの有無 | 「テストはある？」 | なし → 先にテストを書く |

---

## フェーズ1: 現状分析 `cc:TODO`

### 対象ファイル一覧

| ファイル | 問題点 | 優先度 |
|---------|--------|--------|
| src/utils.ts | 関数が長い（100行超）、名前が曖昧 | 高 |
| src/components/Header.tsx | ネストが深い | 中 |
| src/components/Form.tsx | 重複コードあり | 中 |

### コード品質メトリクス（Before）

- 関数の平均行数: 45行
- 最大ネスト深度: 6
- 重複コード: 3箇所

---

## フェーズ2: テスト作成 `cc:TODO` `[feature:tdd]`

**重要**: 動作を変えないことを保証するため、先にテストを書く

### テストケース設計

| 対象関数 | テストケース | 入力 | 期待出力 |
|---------|-------------|------|---------|
| calculate | 正常系 | `(10, 2)` | `5` |
| calculate | ゼロ除算 | `(10, 0)` | エラー |
| formatDate | 正常系 | `Date` | `string` |

---

## フェーズ3: リファクタリング実行 `cc:TODO`

### 3.1 関数の分割

```typescript
// Before: 100行の長い関数
function processData(data) { ... }

// After: 責務ごとに分割
function validateData(data) { ... }
function transformData(data) { ... }
function saveData(data) { ... }
```

### 3.2 命名の改善

| Before | After | 理由 |
|--------|-------|------|
| `fn` | `calculateTotal` | 何をする関数か明確に |
| `data` | `userProfile` | 何のデータか明確に |
| `x` | `itemCount` | 意味のある名前に |

### 3.3 重複コードの解消

- 共通処理を抽出してヘルパー関数化

---

## フェーズ4: 回帰テスト `cc:TODO`

- [ ] 全テストが通ることを確認
- [ ] 既存機能が壊れていないことを手動確認
- [ ] コードレビュー依頼

---

## フェーズ5: 品質メトリクス確認 `cc:TODO`

### コード品質メトリクス（After）

| メトリクス | Before | After | 目標 |
|-----------|--------|-------|------|
| 関数の平均行数 | 45行 | 15行 | < 20行 |
| 最大ネスト深度 | 6 | 3 | < 4 |
| 重複コード | 3箇所 | 0箇所 | 0 |
```

## 評価ポイント

### 必須要素

1. ✅ 対象範囲の明確化
2. ✅ 「綺麗」の具体的な定義
3. ✅ 動作保証のためのテスト計画
4. ✅ `[feature:tdd]` マーカー
5. ✅ Before/After のメトリクス比較
6. ✅ 回帰テストの計画
