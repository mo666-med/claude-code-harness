# 品質判定ゲート

> このルールは Claude harness によって自動生成されました。
> 目的: タスク種別・ファイルパスから適切な品質基準を自動提案します。

## 品質判定マトリクス

| 判定タイプ | 発動条件 | 対象スキル | 提案内容 |
|-----------|---------|-----------|---------|
| **TDD** | [feature] + ビジネスロジック | impl, verify | テスト先行を提案 |
| **セキュリティ** | auth/, api/, payment/ | impl, review, auth | チェックリスト表示 |
| **カバレッジ** | テストなし/不足検出 | review | テスト追加を指摘 |
| **a11y** | UI コンポーネント | ui, review | アクセシビリティチェック |
| **パフォーマンス** | DB クエリ, ループ | impl, review | 最適化警告 |

## 判定フロー

```
タスク受領
    ↓
┌─────────────────────────────────────────┐
│           品質判定ゲート                 │
├─────────────────────────────────────────┤
│  入力:                                  │
│  - Plans.md のタグ: [feature]/[bugfix]  │
│  - 対象ファイルパス                      │
│  - 変更内容のキーワード                  │
│                                         │
│  判定:                                  │
│  ├── TDD 推奨？                         │
│  ├── セキュリティ注意？                  │
│  ├── パフォーマンス注意？                │
│  ├── a11y 注意？                        │
│  └── カバレッジ不足？                   │
│                                         │
│  出力: 該当する判定を提案               │
└─────────────────────────────────────────┘
          ↓
    各スキル/コマンドで提案表示
```

## 判定基準詳細

### TDD 判定

| 条件 | TDD 推奨度 |
|------|-----------|
| [feature] + src/core/ | ★★★ 強く推奨 |
| [feature] + src/services/ | ★★★ 強く推奨 |
| [feature] + src/api/ | ★★☆ 推奨 |
| [bugfix] | ★★☆ 再現テスト推奨 |
| [config], [docs] | ☆☆☆ 不要 |

### セキュリティ判定

| パス | 注意レベル |
|------|-----------|
| auth/, login/, session/ | 🔴 高 |
| api/, routes/, middleware/ | 🟠 中 |
| payment/, billing/, stripe/ | 🔴 高 |
| config/, .env | 🟠 中 |

### a11y 判定

| パス | チェック項目 |
|------|------------|
| src/components/ | alt, aria, キーボード操作 |
| src/app/, src/pages/ | 見出し構造, フォーカス管理 |
| UI ライブラリ使用 | コンポーネントの a11y 対応確認 |

### パフォーマンス判定

| パターン | 警告内容 |
|---------|---------|
| `SELECT * FROM` + ループ内 | N+1 クエリの可能性 |
| 大きな配列の `.map().filter()` | 複数回走査 |
| `useEffect` 内の重い処理 | レンダリング遅延 |
| 画像の直接読み込み | 最適化検討 |

## 提案テンプレート

### エンジニア向け

```markdown
## 🎯 品質判定結果

このタスクに対して以下の品質基準を推奨します：

| 判定 | 推奨度 | 理由 |
|------|--------|------|
| TDD | ★★★ | [feature] タグ + ビジネスロジック |
| セキュリティ | ★★☆ | API エンドポイント変更 |

### 推奨アクション
1. テストファイルを先に作成
2. セキュリティチェックリストを確認

続行しますか？
```

### VibeCoder 向け

```markdown
## 🎯 この作業で気をつけること

1. **成功基準を先に決めましょう**
   - 「何ができたら OK か」をリストにします

2. **セキュリティ確認**
   - ログイン関連なので、専門家にも見てもらうと安心です

進め方を選んでください：
1. 成功基準から作る（推奨）
2. とりあえず作り始める
```

## スキル別の活用方法

### impl スキル

```
Step 0: 品質判定ゲート
    ↓
判定結果を表示
    ↓
ユーザー選択に応じて実装開始
```

### review スキル

```
レビュー開始
    ↓
品質判定ゲートで重点領域を特定
    ↓
├── セキュリティ判定あり → セキュリティ重点レビュー
├── カバレッジ不足 → テスト追加を指摘
└── a11y 判定あり → アクセシビリティチェック
```

### verify スキル

```
エラー報告
    ↓
TDD 判定（再現テスト推奨？）
    ↓
├── バグ報告 → 再現テスト提案
└── テスト失敗 → テスト vs 実装の判断
```

## 設定

### 判定の有効/無効

`.claude-code-harness.config.yaml`:

```yaml
quality_gates:
  tdd:
    enabled: true
    auto_propose: true  # 自動提案
  security:
    enabled: true
    level: medium  # low / medium / high
  a11y:
    enabled: true
  performance:
    enabled: true
```

### 判定のカスタマイズ

```yaml
quality_gates:
  tdd:
    paths:
      high_priority:
        - src/core/**
        - src/domain/**
      exclude:
        - src/utils/**
```

## 注意事項

- **提案であり強制ではない**: ユーザーが最終判断
- **false positive を許容**: 安全側に倒す
- **複数判定の同時表示**: 該当する全ての判定を表示
- **学習と改善**: フィードバックを SSOT に記録して改善
