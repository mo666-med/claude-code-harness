# claude-code-harness 修正プラン（2025-12-12）

**目的**: VibeCoder向けプラグインとしての価値（Plan→Work→Reviewの型）を維持しつつ、**最新の Claude Code プラグイン仕様に確実に適合**させ、**衝突/不整合/自動化の空振り**を潰して「迷わず動く」状態にする。  
**前提**: この文書は「何を直すか」の計画のみ。実装は別途。

参照（仕様/思想）:
- Plugins（概要）: `https://docs.claude.com/en/docs/claude-code/plugins`
- Plugins reference（マニフェスト/構造）: `https://code.claude.com/docs/en/plugins-reference`
- Slash commands（frontmatter等）: `https://code.claude.com/docs/en/slash-commands`
- Hooks 設定（ブログ）: `https://claude.com/ja-jp/blog/how-to-configure-hooks`
- Skills 解説（ブログ）: `https://claude.com/ja-jp/blog/skills-explained`
- 参考: `mpz/REVIEW_REPORT_Comp.md`

---

## 0. 先に決めたいこと（選択式）

以下はプランの“分岐点”です。**選んだ番号/記号だけ返してください**（複数可）。

### Q1. 対象とする Claude Code の互換範囲
- **A**: 最新仕様に寄せて最適化（`plugins-reference` 準拠を最優先）
- **B**: 旧挙動も配慮（移行ガイドを厚くし、なるべく破壊変更を避ける）
- **C**: 特定バージョン固定（「このバージョンで動く」を保証）

**推奨**: A（プラグインは配布される前提なので“今動く”を最優先）

### Q2. `init` と `review` の“組み込み衝突”の扱い
- **A**: コマンドを改名して衝突回避（例: `/harness-init`, `/harness-review`）
- **B**: 改名せず、常に名前空間呼び出しを推奨（例: `/claude-code-harness:harness-init`）
- **C**: 両方（改名 + 旧名はエイリアスとして残す/移行期間を設ける）

**推奨**: A（改名して統一。旧名コマンドは廃止）

### Q3. ソロ（Claude Code単独）と 2-agent（Cursor連携）の位置づけ
- **A**: ソロ専用として整理（2-agent 由来の文言/機能を縮退）
- **B**: ソロ + 2-agent 両対応として整合を取る（現状方針の延長）
- **C**: 2-agent を別プラグインに分離（責務を明確化）

**推奨**: B（READMEに「Cursor連携（オプション）」があるため）

### Q4. Hooks の拡充方針（自動化/ガードレール）
- **A**: まずは“今ある hooks が確実に効く”状態へ（stdin/スキーマ整合を最優先）
- **B**: Aに加え、`PreToolUse` / `PermissionRequest` も導入してUX/安全性を強化
- **C**: `PreToolUse` のみ導入（PermissionRequest は入れない）

**推奨**: B（ただし組織ポリシーが厳しければC→段階導入でも可）

### Q5. バージョンの単一の真実（SSOT）
- **A**: `.claude-plugin/plugin.json` をSSOT（README/VERSION/CHANGELOGが追従）
- **B**: `VERSION` をSSOT
- **C**: `CHANGELOG.md` をSSOT

**推奨**: A（プラグイン配布の基準点として自然）

---

## 1. 修正対象一覧（漏れなく直す）

### 1-1. マニフェスト（`.claude-plugin/plugin.json`）を最新仕様へ
**狙い**: Claude Code が確実に読み込める形にする（仕様準拠）。  
**作業**:
- `plugins-reference` の schema に合わせてフィールド再構成（author/commands 等）
- `license` / `keywords` の追加（他AIレポートでも指摘）
- `commands` は原則 **`commands/` 自動検出**に任せ、マニフェストでの“手動リスト”をやめる（不整合の根本原因を除去）
- `homepage`/`repository` の型も最新例に合わせて整理

**完了条件**:
- `claude --debug` で manifest エラーが出ない
- `/help` にコマンドが期待通り出る（衝突時は名前空間で確認）

### 1-2. Commands: frontmatter を全コマンドに付与・統一
**狙い**: `/help`/補完/自動実行（SlashCommand tool）との相性を上げる。  
**作業**:
- 全 `commands/*.md` の先頭に `---` を付け、最低限 `description` を入れる
- 必要に応じて `argument-hint` / `allowed-tools` / `disable-model-invocation` を追加
- `commands/localize-rules.md` の非標準 frontmatter（`name:` 等）を、最新仕様の frontmatter に寄せる

**完了条件**:
- `/help` の説明が意図通りに表示される
- 主要コマンドが（必要なら）`SlashCommand` ツールの対象として扱える状態になる

### 1-3. Agents: frontmatter（description/capabilities）追加
**狙い**: `/agents` での発見性・使い分けを明確化。  
**作業**:
- `plugins-reference` 例に合わせて frontmatter 追加（description/capabilities）
- 「いつ使うべきか」を明記し、スキルとの違いも書く（skills-explained の思想）

### 1-4. Hooks: “空振り”をなくし、stdin 仕様に合わせる
**狙い**: 自動テスト推奨/変更追跡/Plans監視などが実際に動く。  
**作業**:
- `PostToolUse` で呼ばれる `scripts/*.sh` を **stdin JSON入力**対応へ統一（`auto-cleanup-hook.sh` と同じ型）
  - file_path の取り出し
  - tool_name の取り出し
  - jq がない環境のフォールバック（または明示的に依存にする）
- `hooks/hooks.json` のスキーマ/イベント/ matcher 設計を `hooks` ガイドに合わせて点検
- （Q4で選んだ場合）`PreToolUse`/`PermissionRequest` を追加し、
  - 危険操作ブロック（例: protected paths への書き込み）
  - テストコマンド自動承認の最適化

**完了条件**:
- 変更時に `.claude/state/` が期待通り更新される
- テスト推奨が適切に出る（誤爆しない）
- hooks がタイムアウトせず、失敗してもセッションが壊れない

### 1-5. コマンド衝突の解消（または明確化）
**狙い**: VibeCoder が迷わず使える。  
**作業（Q2の選択に依存）**:
- 改名する場合: `init` `review` を衝突しない名前へ移行（例: `/harness-init`, `/harness-review`。旧名コマンドは廃止）
- 改名しない場合: README/ガイドの例を **常に名前空間付き**に変更（長い prefix をどう扱うか含めてUX設計）

**完了条件**:
- README のコマンド例が、どの環境でも期待通り動く

### 1-6. ドキュメントと実体の整合・用語整理
**狙い**: “読むだけで迷わない”状態。  
**作業**:
- README のコマンド一覧を `commands/` と一致させる（存在しない `/setup-cursor` 等の扱い）
- `cursor-cc-plugins` 由来の表記（scripts/hooks description 等）を整理（Q3次第）
- `docs/ARCHITECTURE.md` の記載（例: schemaファイル名）を現物に合わせる

### 1-7. バージョン整合（SSOT決定 → 同期）
**狙い**: 配布/更新/サポートが説明できる。  
**作業（Q5の選択に依存）**:
- SSOT を決めて、`README`/`VERSION`/`CHANGELOG` を同期
- `CHANGELOG.md` のプロダクト名・履歴の整理（cursor-cc-plugins からの移行を明記）

### 1-8. 検証（“動く”の確認）
**狙い**: 変更後に確実に使える。  
**作業**:
- `./tests/validate-plugin.sh` を CI でもローカルでも再現性ある形に（依存の明確化）
- `claude --debug` で plugin load を確認（manifest/commands/agents/hooks）
- `/help` `/agents` `/hooks` で表示/挙動を確認

---

## 2. 実行順（おすすめロードマップ）

1. **Q1〜Q5を確定**（方針決め）
2. **manifest 修正（1-1）** → “ロードできる”を最優先で確保
3. **commands frontmatter（1-2）** → “見つかる/迷わない”
4. **衝突整理（1-5）** → “詰まらない”
5. **hooks stdin 統一（1-4）** → “自動化が効く”
6. **docs/版管理（1-6, 1-7）**
7. **検証（1-8）**

---

## 3. 完了後にどう変わるか（ゴール像）

- **今まで**:  
  - manifest/コマンド定義/フックの“仕様適合”が揺れており、環境差で詰まる可能性  
  - 組み込み `init`/`review` と衝突しうる  
  - hooks が空振りして “自動化が効いていない” 状態になり得る  
  - バージョン表示がバラバラで、配布物として説明しづらい

- **これから（修正後）**:  
  - 最新仕様準拠で “確実にロードされる”  
  - コマンドが `/help`/補完でわかりやすい（frontmatter統一）  
  - 衝突は回避または明示され、VibeCoderが迷わない  
  - hooks が stdin を正しく処理し、監視/テスト推奨/追跡が確実に動く  
  - 版管理が一貫し、配布/運用がしやすい


