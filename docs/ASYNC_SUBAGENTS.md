# 非同期サブエージェントによる高度なワークフロー

## 1. 非同期サブエージェントとは？

**非同期サブエージェント**は、Claude Codeのセッション内で**バックグラウンドで独立して動作するエージェント**です。これにより、長時間かかるタスクを実行させながら、メインのエージェントで別の作業を続けることができます。

### 主な機能

- **バックグラウンド実行**: `Ctrl + B`を押すことで、現在実行中のサブエージェントをバックグラウンドに送ります。
- **独立動作**: メインエージェントが終了しても、バックグラウンドのサブエージェントはタスクを続行します。
- **Resumable**: `agentId`を使って、後からタスクを再開できます。

### 現状の制約

**重要**: 現時点では、サブエージェントのバックグラウンド実行は**ユーザーによる手動操作（`Ctrl + B`）**でのみ可能です。コマンドから自動的にバックグラウンド実行を開始する**プログラマティックAPIは提供されていません**。

---

## 2. 手動ワークフローの具体的な手順

### ユースケース1: 真の並列コードレビュー

複数のレビューを同時に実行し、大幅な時間短縮を実現します。

**手順**:
1.  **最初のレビューを開始**
    ```
    > /harness-review security ./src
    ```
2.  **バックグラウンドへ送る**
    - サブエージェントがレビューを開始したら、すぐにキーボードで `Ctrl + B` を押します。
    - メインエージェントのプロンプトが再び表示されます。
3.  **次のレビューを開始**
    ```
    > /harness-review performance ./src
    ```
4.  **バックグラウンドへ送る**
    - 同様に `Ctrl + B` を押します。
5.  **すべてのレビューを起動**
    - `quality`、`accessibility`など、必要なレビューをすべて同様にバックグラウンドで起動します。
6.  **他の作業を続ける**
    - すべてのレビューがバックグラウンドで実行されている間、メインエージェントでドキュメント作成や次の機能の計画など、別の作業を進めることができます。
7.  **完了通知**
    - 各サブエージェントが完了すると、メインエージェントに通知が表示されます。

### ユースケース2: 長時間タスクの監視

ビルドやテストなど、完了までに時間がかかるタスクの監視を任せます。

**手順**:
1.  **監視タスクを開始**
    ```
    > Use the explore subagent to monitor the output of 'npm run test:e2e' and report the final result.
    ```
2.  **バックグラウンドへ送る**
    - `Ctrl + B` を押します。
3.  **他の作業を続ける**
    - テストが実行されている間、コードのリファクタリングやバグ修正など、他の作業に集中できます。
4.  **完了通知**
    - テストが完了または失敗した時点で、サブエージェントが結果を報告します。

---

## 3. `SubagentStop`フックとの連携

非同期サブエージェントの真価は、**`SubagentStop`フック**と組み合わせることで発揮されます。このフックは、サブエージェントが完了したときに自動的にトリガーされます。

### 何ができるか？

- **結果の自動評価**: サブエージェントの出力が品質基準を満たしているか自動でチェック
- **結果の保存**: レビュー結果を自動的にファイルに保存
- **次のタスクのトリガー**: レビューで問題が見つかった場合、自動的に修正タスクを起動（※将来的な展望）

### 設定例

`.claude/settings.json`に以下の設定を追加することで、サブエージェント完了時にカスタムスクリプトを実行できます。

```json
{
  "hooks": {
    "SubagentStop": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "/path/to/your/evaluate_output.sh"
          }
        ]
      }
    ]
  }
}
```

このスクリプト内で、サブエージェントの出力（標準入力経由で渡される）を解析し、必要な処理を実行します。

---

## 4. ベストプラクティスと注意点

- **トークン管理**: 複数のサブエージェントを同時に実行すると、トークン消費量が増加します。計画的に使用してください。
- **レースコンディション**: 複数のサブエージェントが同じファイルを同時に編集しようとすると、競合が発生する可能性があります。`git worktree`を使用して、各エージェントに個別の作業ディレクトリを提供することを推奨します。
- **VSCode版での非対応**: 現在、VSCodeの統合ターミナルでは`Ctrl+B`が正しく機能しない場合があります。ネイティブのターミナルでの使用を推奨します。
- **手動操作の必要性**: 現状では、すべてのバックグラウンド実行は手動でトリガーする必要があります。完全な自動化は、将来の公式APIの提供を待つ必要があります。
