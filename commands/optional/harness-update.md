---
description: ハーネス導入済みプロジェクトを最新版に安全アップデート（バージョン検出→バックアップ→非破壊更新）
description-en: Safely update harness-enabled projects to latest version (version detection → backup → non-destructive update)
---

# /harness-update - ハーネスアップデート

既にハーネスが導入されているプロジェクトを、最新バージョンのハーネスに安全にアップデートします。
**バージョン検出→バックアップ→非破壊更新**の流れで、既存の設定やタスクを保持しながら最新機能を導入できます。

## こんなときに使う

- 「ハーネスを最新版にアップデートしたい」
- 「新機能を既存プロジェクトに追加したい」
- 「設定ファイルのフォーマットを最新版に合わせたい」
- 「間違ったパーミッション構文を修正したい」

## できること

- `.claude-code-harness-version` でバージョン検出
- 更新が必要なファイルの特定
- 自動バックアップ作成
- 非破壊で設定・ワークフローファイルを更新
- アップデート後の検証

---

## 実行フロー

### Phase 1: バージョン検出と確認

#### Step 1: ハーネス導入状況の確認

`.claude-code-harness-version` ファイルを確認：

```bash
if [ -f .claude-code-harness-version ]; then
  CURRENT_VERSION=$(grep "^version:" .claude-code-harness-version | cut -d' ' -f2)
  echo "検出されたバージョン: $CURRENT_VERSION"
else
  echo "⚠️ ハーネス未導入のプロジェクトです"
  echo "→ /harness-init を使用してください"
  exit 1
fi
```

**ハーネス未導入の場合:**
> ⚠️ **このプロジェクトにはハーネスが導入されていません**
>
> `/harness-update` は既にハーネス導入済みのプロジェクト用です。
> 新規導入には `/harness-init` を使用してください。

**導入済みの場合:** → Step 2 へ

#### Step 2: バージョン比較

プラグインの最新バージョンと比較：

```bash
PLUGIN_VERSION=$(cat "$CLAUDE_PLUGIN_ROOT/claude-code-harness/VERSION" 2>/dev/null || echo "unknown")

if [ "$CURRENT_VERSION" = "$PLUGIN_VERSION" ]; then
  echo "✅ 既に最新版です (v$PLUGIN_VERSION)"
else
  echo "📦 アップデート可能: v$CURRENT_VERSION → v$PLUGIN_VERSION"
fi
```

**既に最新版の場合:**
> ✅ **プロジェクトは既に最新版です (v{{VERSION}})**
>
> アップデートの必要はありません。
> 特定のファイルだけ更新したい場合は、以下のスキルを個別に実行できます：
> - `generate-claude-settings` - .claude/settings.json の更新
> - `migrate-workflow-files` - AGENTS.md, CLAUDE.md, Plans.md の更新

**アップデート可能な場合:** → Step 3 へ

#### Step 3: 更新範囲の確認

更新対象ファイルを特定してユーザーに確認：

> 📦 **アップデート: v{{CURRENT}} → v{{LATEST}}**
>
> **更新されるファイル:**
> - `.claude/settings.json` - セキュリティポリシーと最新構文に更新
> - `AGENTS.md` / `CLAUDE.md` / `Plans.md` - 最新フォーマットに更新（既存タスクは保持）
> - `.claude/rules/` - 最新ルールテンプレートに更新
> - `.cursor/commands/` - Cursor コマンド更新（2-Agent モードの場合）
> - `.claude-code-harness-version` - バージョン情報更新
>
> **既存データは保持されます:**
> - ✅ Plans.md の未完了タスク
> - ✅ .claude/settings.json のカスタム設定（hooks, env, model など）
> - ✅ .claude/memory/ の SSOT データ
>
> **バックアップ:**
> - 変更前のファイルは `.claude-code-harness/backups/{{TIMESTAMP}}/` に保存されます
>
> アップデートを実行しますか？ (yes / no / カスタム)
>
> **カスタム**: 特定のファイルだけ更新したい場合は「カスタム」を選択

**回答を待つ**

- **yes** → Phase 2 (全体アップデート)
- **no** → 終了
- **カスタム** → Phase 2A (選択的アップデート)

---

## Phase 2: バックアップと更新

### Step 1: バックアップディレクトリ作成

```bash
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR=".claude-code-harness/backups/$TIMESTAMP"
mkdir -p "$BACKUP_DIR"

# バックアップ対象ファイルをコピー
[ -f .claude/settings.json ] && cp .claude/settings.json "$BACKUP_DIR/"
[ -f AGENTS.md ] && cp AGENTS.md "$BACKUP_DIR/"
[ -f CLAUDE.md ] && cp CLAUDE.md "$BACKUP_DIR/"
[ -f Plans.md ] && cp Plans.md "$BACKUP_DIR/"
[ -d .claude/rules ] && cp -r .claude/rules "$BACKUP_DIR/"
[ -d .cursor/commands ] && cp -r .cursor/commands "$BACKUP_DIR/"

echo "✅ バックアップ作成: $BACKUP_DIR"
```

### Step 2: 設定ファイルの更新

**`.claude/settings.json` の更新** - `generate-claude-settings` スキルを実行:

- 既存の `hooks`, `env`, `model`, `enabledPlugins` は保持
- `permissions.allow|ask|deny` は最新ポリシーとマージ + 重複排除
- **重要**: 間違ったパーミッション構文 (`"Bash(npm run *)"`) があれば自動修正 (`"Bash(npm run:*)"`)
- `permissions.disableBypassPermissionsMode` は設定しない（bypassPermissions を許可）

### Step 3: ワークフローファイルの更新

**`AGENTS.md` / `CLAUDE.md` / `Plans.md` の更新** - `migrate-workflow-files` スキルを実行:

- `Plans.md`: 未完了タスクを保持しつつ、最新フォーマットにマージ
- `AGENTS.md` / `CLAUDE.md`: 最新テンプレート骨格 + プロジェクト固有ルールを適切な場所に再配置

### Step 4: ルールファイルの更新

`.claude/rules/` の更新:

```bash
PLUGIN_PATH="${CLAUDE_PLUGIN_ROOT:-$HOME/.claude/plugins/claude-code-harness}"

# 最新のルールテンプレートをコピー
for template in "$PLUGIN_PATH/templates/rules"/*.template; do
  if [ -f "$template" ]; then
    rule_name=$(basename "$template" .template)
    cp "$template" ".claude/rules/$rule_name"
    echo "✅ 更新: .claude/rules/$rule_name"
  fi
done
```

### Step 5: Cursor コマンドの更新（2-Agent モードの場合）

`.cursor/commands/` が存在する場合のみ更新:

```bash
if [ -d .cursor/commands ]; then
  PLUGIN_PATH="${CLAUDE_PLUGIN_ROOT:-$HOME/.claude/plugins/claude-code-harness}"

  # 最新のコマンドテンプレートをコピー
  for cmd in "$PLUGIN_PATH/templates/cursor/commands"/*.md; do
    if [ -f "$cmd" ]; then
      cp "$cmd" .cursor/commands/
      echo "✅ 更新: $(basename $cmd)"
    fi
  done
fi
```

### Step 6: バージョンファイルの更新

`.claude-code-harness-version` を最新版に更新:

```bash
cat > .claude-code-harness-version <<EOF
# claude-code-harness version tracking
# This file is auto-generated by /harness-update
# DO NOT manually edit - used for update detection

version: $PLUGIN_VERSION
installed_at: $(grep "^installed_at:" .claude-code-harness-version | cut -d' ' -f2)
updated_at: $(date +%Y-%m-%d)
last_setup_command: harness-update
EOF

echo "✅ バージョン更新: v$CURRENT_VERSION → v$PLUGIN_VERSION"
```

---

## Phase 2A: 選択的アップデート（カスタム選択時）

> 📋 **どのファイルを更新しますか？**
>
> 1. `.claude/settings.json` - セキュリティポリシーとパーミッション構文
> 2. `AGENTS.md` / `CLAUDE.md` / `Plans.md` - ワークフローファイル
> 3. `.claude/rules/` - ルールテンプレート
> 4. `.cursor/commands/` - Cursor コマンド（2-Agent モード）
> 5. すべて
>
> 番号で選択してください（複数可、カンマ区切り）:

**回答を待つ**

選択されたファイルのみ Phase 2 の該当 Step を実行。

---

## Phase 3: 検証と完了

### Step 1: 更新後の検証

```bash
# settings.json の構文チェック
if command -v jq >/dev/null 2>&1; then
  jq empty .claude/settings.json 2>/dev/null && echo "✅ settings.json: 有効" || echo "⚠️ settings.json: 構文エラー"
fi

# バージョンファイルの確認
[ -f .claude-code-harness-version ] && echo "✅ version file: 存在" || echo "⚠️ version file: なし"
```

### Step 2: アップデート完了レポート

> ✅ **アップデートが完了しました！**
>
> **更新内容:**
> - バージョン: v{{CURRENT}} → v{{LATEST}}
> - 更新ファイル: {{更新されたファイルリスト}}
> - バックアップ: `.claude-code-harness/backups/{{TIMESTAMP}}/`
>
> **次のステップ:**
> - 「`/sync-status`」→ 現在の状態を確認
> - 「`/plan-with-agent` 〇〇を作りたい」→ 新しいタスクを追加
> - 「`/work`」→ Plans.md のタスクを実行
>
> **問題が発生した場合:**
> ```bash
> # バックアップから復元
> cp -r .claude-code-harness/backups/{{TIMESTAMP}}/* .
> ```

---

## Phase 2B: 選択的アップデート（カスタム選択時）

ユーザーが選択したファイルのみ更新します。

---

## 注意事項

- **バックアップは必須**: 更新前に必ずバックアップを作成
- **既存データは保持**: Plans.md のタスク、settings.json のカスタム設定は保持
- **非破壊マージ**: 既存ファイルは上書きせず、マージして更新
- **検証を忘れずに**: アップデート後は `/sync-status` で状態確認

---

## トラブルシューティング

### Q: アップデート後に設定が消えた

A: バックアップから復元してください：
```bash
cp -r .claude-code-harness/backups/{{TIMESTAMP}}/* .
```

### Q: パーミッション構文エラーが出る

A: `.claude/settings.json` を手動で修正するか、再度 `/harness-update` を実行してください。
正しい構文: `"Bash(npm run:*)"` / 間違い: `"Bash(npm run *)"`

### Q: 特定のファイルだけ更新したい

A: 「カスタム」を選択して、必要なファイルだけ選択してください。

---

## 関連コマンド

- `/harness-init` - 新規プロジェクトのセットアップ
- `/sync-status` - 現在のプロジェクト状態確認
- `/validate` - プロジェクト構造の検証
