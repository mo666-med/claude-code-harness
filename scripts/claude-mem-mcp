#!/usr/bin/env bash
# claude-mem-mcp - Claude-mem MCP wrapper for Cursor integration
#
# This script:
# 1. Checks if claude-mem worker is running (health check)
# 2. Auto-starts worker if not running
# 3. Dynamically detects latest claude-mem version
# 4. Launches MCP server in stdio mode

set -euo pipefail

# Constants
WORKER_HEALTH_URL="http://127.0.0.1:37777/health"
PLUGIN_BASE="$HOME/.claude/plugins/cache/thedotmack/claude-mem"
TIMEOUT=5

# Function: Get latest claude-mem version
get_latest_version() {
    local latest_version_path
    latest_version_path=$(ls -1d "$PLUGIN_BASE"/*/ 2>/dev/null | sort -V | tail -1)

    if [ -z "$latest_version_path" ]; then
        echo "エラー: claude-mem プラグインが見つかりません: $PLUGIN_BASE" >&2
        exit 1
    fi

    echo "$latest_version_path"
}

# Function: Check if worker is running
is_worker_running() {
    if curl -s -f --max-time "$TIMEOUT" "$WORKER_HEALTH_URL" > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# Function: Start worker
start_worker() {
    local version_path="$1"
    local worker_cli="$version_path/scripts/worker-cli.js"

    if [ ! -f "$worker_cli" ]; then
        echo "エラー: worker-cli.js が見つかりません: $worker_cli" >&2
        exit 1
    fi

    echo "claude-mem worker を起動中..." >&2
    node "$worker_cli" start > /dev/null 2>&1

    # Worker の起動を待機
    local max_retries=10
    local retry=0
    while [ $retry -lt $max_retries ]; do
        if is_worker_running; then
            echo "Worker が正常に起動しました" >&2
            return 0
        fi
        sleep 1
        retry=$((retry + 1))
    done

    echo "エラー: Worker が ${max_retries} 秒以内に起動しませんでした" >&2
    exit 1
}

# メイン処理
main() {
    # 最新バージョンのパスを取得
    LATEST_VERSION=$(get_latest_version)
    echo "claude-mem バージョン: $(basename "$LATEST_VERSION")" >&2

    # Worker の状態をチェック
    if ! is_worker_running; then
        echo "Worker が起動していません。起動を試みます..." >&2
        start_worker "$LATEST_VERSION"
    else
        echo "Worker は起動済みです" >&2
    fi

    # MCP サーバーを起動
    MCP_SERVER="$LATEST_VERSION/scripts/mcp-server.cjs"

    if [ ! -f "$MCP_SERVER" ]; then
        echo "エラー: mcp-server.cjs が見つかりません: $MCP_SERVER" >&2
        exit 1
    fi

    echo "MCP サーバーを起動中..." >&2
    exec node "$MCP_SERVER"
}

main "$@"
