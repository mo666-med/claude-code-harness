name: Consistency Check

on:
  push:
    branches: [main]
    paths:
      - 'commands/**'
      - 'skills/**'
      - 'templates/**'
      - 'hooks/**'
      - 'scripts/**'
      - 'VERSION'
      - '.claude-plugin/plugin.json'
  pull_request:
    branches: [main]
    paths:
      - 'commands/**'
      - 'skills/**'
      - 'templates/**'
      - 'hooks/**'
      - 'scripts/**'
      - 'VERSION'
      - '.claude-plugin/plugin.json'

jobs:
  consistency:
    name: Check Plugin Consistency
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run consistency check
        run: |
          chmod +x ./scripts/ci/check-consistency.sh
          ./scripts/ci/check-consistency.sh

  version-sync:
    name: Check Version Sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Compare VERSION and plugin.json
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')
          JSON_VERSION=$(grep '"version"' .claude-plugin/plugin.json | head -1 | sed 's/.*: *"\([^"]*\)".*/\1/')

          echo "VERSION file: $FILE_VERSION"
          echo "plugin.json:  $JSON_VERSION"

          if [ "$FILE_VERSION" != "$JSON_VERSION" ]; then
            echo "::error::Version mismatch: VERSION=$FILE_VERSION, plugin.json=$JSON_VERSION"
            exit 1
          fi

          echo "Versions are in sync"

  template-exists:
    name: Check Required Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify required templates exist
        run: |
          ERRORS=0

          TEMPLATES=(
            "templates/AGENTS.md.template"
            "templates/CLAUDE.md.template"
            "templates/Plans.md.template"
            "templates/.cursor-cc-version.template"
            "templates/cursor/commands/start-session.md"
            "templates/cursor/commands/handoff-to-claude.md"
            "templates/cursor/commands/review-cc-work.md"
            "templates/rules/workflow.md.template"
            "templates/rules/coding-standards.md.template"
            "templates/rules/plans-management.md.template"
            "templates/rules/testing.md.template"
          )

          for template in "${TEMPLATES[@]}"; do
            if [ ! -f "$template" ]; then
              echo "::error::Missing template: $template"
              ERRORS=$((ERRORS + 1))
            else
              echo "Found: $template"
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

  hooks-validation:
    name: Validate Hooks Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate hooks.json
        run: |
          if ! jq empty hooks/hooks.json 2>/dev/null; then
            echo "::error::hooks/hooks.json is not valid JSON"
            exit 1
          fi

          SCRIPT_REFS=$(grep -oE 'scripts/[a-zA-Z0-9_.-]+' hooks/hooks.json || true)
          ERRORS=0

          for ref in $SCRIPT_REFS; do
            if [ ! -f "$ref" ]; then
              echo "::error::Hook references missing script: $ref"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            exit 1
          fi

          echo "hooks.json is valid"

  checklist-sync:
    name: Check Checklist Sync
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify command checklists match scripts
        run: |
          chmod +x ./scripts/ci/check-checklist-sync.sh
          ./scripts/ci/check-checklist-sync.sh

  version-bump:
    name: Check Version Bump
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify version was bumped
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          chmod +x ./scripts/ci/check-version-bump.sh
          ./scripts/ci/check-version-bump.sh

  readme-version-sync:
    name: Check README Version Badge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify README version badges match VERSION file
        run: |
          FILE_VERSION=$(cat VERSION | tr -d '[:space:]')

          echo "VERSION file: $FILE_VERSION"

          ERRORS=0

          # Check README.md
          if grep -q "version-${FILE_VERSION}-green" README.md; then
            echo "README.md: OK (v${FILE_VERSION})"
          else
            README_VERSION=$(grep -oE 'version-[0-9]+\.[0-9]+\.[0-9]+-green' README.md | head -1 | sed 's/version-//;s/-green//')
            echo "::error::README.md version badge ($README_VERSION) doesn't match VERSION file ($FILE_VERSION)"
            ERRORS=$((ERRORS + 1))
          fi

          # Check README.ja.md
          if grep -q "version-${FILE_VERSION}-green" README.ja.md; then
            echo "README.ja.md: OK (v${FILE_VERSION})"
          else
            README_JA_VERSION=$(grep -oE 'version-[0-9]+\.[0-9]+\.[0-9]+-green' README.ja.md | head -1 | sed 's/version-//;s/-green//')
            echo "::error::README.ja.md version badge ($README_JA_VERSION) doesn't match VERSION file ($FILE_VERSION)"
            ERRORS=$((ERRORS + 1))
          fi

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "Fix: Update the version badges in README.md and README.ja.md"
            echo "  Find: version-X.Y.Z-green"
            echo "  Replace with: version-${FILE_VERSION}-green"
            exit 1
          fi

          echo "All README version badges are in sync"
